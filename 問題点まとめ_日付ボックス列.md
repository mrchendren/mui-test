# 問題点まとめ：DataGrid日付ボックス列

## 確認実施日
2026年1月7日

## 確認手順
1. DataGridテスト画面で日付列のセルをダブルクリックして編集モードに入る
2. カレンダーボタンをクリックしてカレンダーを開く
3. 日付を選択（1月15日を選択）
4. 編集モードが終了し、「令和08年01月15日」と表示されることを確認
5. 同じセルを再度ダブルクリックして編集モードに入る
6. 入力欄に「090115」と入力（元号部分を1年ずらす：08→09）
7. TABキーでフォーカスアウト

## 発見された問題点

### 問題1: 編集モードに入ったときの表示が正しくない
**現象**：
- 編集モードに入ったとき、入力欄に「令和08年01月15日」（元号形式）が表示される
- 期待される表示：`080115`（yyMMdd形式、6桁）

**影響**：
- ユーザーが手入力で編集しにくい
- 元のGengoDateCalenderとは異なる挙動

**原因の推測**：
- `displayValue`の計算で、`focused`が`true`の時に`formatEra(value)`が使われている可能性
- または、`focused`が`false`のままになっている可能性

### 問題2: フォーカスアウト時に値が反映されない
**現象**：
- 入力欄に「090115」と入力してTABキーでフォーカスアウト
- セルに「令和08年01月15日」のまま表示される（変更されていない）
- 期待される表示：「令和09年01月15日」

**影響**：
- ユーザーが入力した値が保存されない
- データの整合性に問題が発生する

**原因の推測**：
- `handleBlur`で`onRowChange`が呼ばれていない
- または、`onRowChange`が呼ばれているが、`row.date`が更新されていない
- または、`setValue(parsed)`が呼ばれていないため、表示が更新されていない

## 確認が必要なコード箇所

### DateBoxColumn.tsx

1. **`displayValue`の計算（178-180行目付近）**
   - `focused`が`true`の時に`formatYYMMDD(value)`が使われているか確認
   - `focused`の状態が正しく管理されているか確認

2. **`handleBlur`の処理（113-144行目付近）**
   - `editing`が`null`でない場合に`onRowChange`が呼ばれているか確認
   - パース成功時に`setValue(parsed)`が呼ばれているか確認
   - `onRowChange`で`row.date`が正しく更新されているか確認

3. **`handleFocus`の処理（110行目付近）**
   - `setFocused(true)`が正しく呼ばれているか確認

4. **`handleChange`の処理（146-150行目付近）**
   - `editing`が正しく更新されているか確認

## 修正が必要な箇所（推測）

1. `handleBlur`でパース成功時に`setValue(parsed)`を追加（既に修正済みのはずだが、動作確認が必要）
2. `displayValue`の計算で、`focused`が`true`の時に正しく`formatYYMMDD(value)`が使われているか確認
3. `focused`の初期状態が`false`のままになっていないか確認（編集モードに入った時に`true`になるべき）
