# オートコンプリート・ハイブリッド入力コンポーネント完全仕様書

## 1. コンポーネント概要
MUI (v6+) の `Autocomplete` をベースとし、「リスト選択」と「手入力」を高度に共存させたカスタムコンポーネント。検索・絞り込み機能を排除し、ID入力に特化した挙動を提供する。

---

## 2. コア機能要件
### 2.1. 入力・選択挙動
- **自由入力許可 (`freeSolo`)**: リスト外のID入力も許容し、エラーにせず保持する。
- **絞り込み無効化**: 入力中も `options` 全件を常にドロップダウンに表示する。
- **ポップアップ制御**: `freeSolo` 時も下向き三角ボタン（矢印）を表示し、リスト選択を促す。

### 2.2. データ構造と保持
- **内部データ (value state)**: `{ id: string; label: string }` 形式のオブジェクト。
- **リスト外データ**: 入力値を `id` および `label` の両方にセットして保持。
- **バリデーション**: 入力・確定時は制限せず、最終保存時等に「リスト内IDか」を外部ロジックで判定する。
- **手入力時の値**: 手入力時の値は**IDの方**である。入力中（編集中）は入力欄に**全てIDを表示**する。確定後の表示は仕様書の3通り（IDのみ、ラベルのみ、ID:ラベル）のいずれかで設定可能。

---

## 3. 表示モード仕様（3パターン）
`getOptionLabel` をオーバーライドし、以下の表示形式を動的に切り替える。内部データ（オブジェクト）の値は変更せず、描画文字列のみを制御する。

| 表示モード | リスト内ID一致時の表示 | リスト外（不一致）の表示 |
| :--- | :--- | :--- |
| **IDのみ** | `101` | 入力値そのまま |
| **ラベルのみ** | `Apple` | 入力値そのまま |
| **ID:ラベル** | `101: Apple` | 入力値そのまま (※1) |

> (※1) リスト外入力時はラベル情報が存在しないため、装飾（区切り文字 `:`）は行わない。

---

## 4. 入力制御と制限（個別設定）
### 4.1. 桁数制限 (maxLength)
- **対象**: テキストボックスへの直接入力（タイピング）。
- **非対象**: リストからの選択。リスト内のIDが制限を超えていても、選択時はその値を保持・表示する。
- **実装**: `slotProps.htmlInput.maxLength` を使用して物理的に制限する。

### 4.2. 入力不可制御 (readOnly)
- **条件**: 表示モードが **「ラベルのみ」** の場合。
- **挙動**: 直接入力を禁止（`readOnly`）とし、リストからの選択専用とする。

---

## 5. 内部処理ロジック（MUI v6 準拠）

### 5.1. フォーカスアウト（onBlur）時の確定処理
入力された文字列（`inputValue`）を `options` の `id` と照合し、値を確定させる。
1. **一致する場合**: 該当する `{ id, label }` オブジェクトで `value` を更新。
2. **一致しない場合**: `{ id: inputValue, label: inputValue }` で `value` を更新。

### 5.2. getOptionLabel のオーバーライド
1. 引数の `option` オブジェクトが `options` リスト内に存在するか検索。
2. 存在しない、またはモードが `ID` なら `option.id` を返却。
3. 存在し、かつモードが `LABEL` なら `option.label` を返却。
4. 存在し、かつモードが `ID_LABEL` なら `` `${option.id}: ${option.label}` `` を返却。

---

## 6. 要件チェックリスト（テスト観点）
- [ ] 1文字入力した際、ドロップダウンのリストが減らずに全件表示されているか？
- [ ] 設定した桁数（2桁/4桁等）以上の文字をタイピングできないか？
- [ ] リストから桁数以上のIDを選択した際、正しく表示・保持されるか？
- [ ] 「ラベルのみ」モード時、キーボード入力がブロックされ、選択のみ可能か？
- [ ] リスト外のIDを打ってフォーカスを外した際、入力値が消えずに保持されるか？
- [ ] リスト内のID（例: 101）を打って外した際、設定モード（例: ID:ラベル）に自動変換されるか？
- [ ] `InputProps` ではなく `slotProps` が使用されているか？
 
- [ ] コード実装側で `InputProps` を直接扱っていないか確認する（`slotProps` によるスロット単位のプロパティ渡しへ移行されていること）。

> **重要（非推奨）**: `InputProps` を直接実装する方法は推奨されません。MUI の設計方針と今後の互換性観点から、`slotProps` を用いる方式への移行が推奨されています。既存コードで `InputProps` を使用している場合は、改修計画を作成し `slotProps` へ置き換えることを強く推奨します（実装不可避な理由がある場合は、その理由と回避策をレビューノートに残してください）。

- [ ] ESLint による静的解析でエラーが出ていないこと（実行コマンド例: `npm run lint`）。
- [ ] TypeScript の型チェックでエラーが出ていないこと（実行コマンド例: `npx tsc -p tsconfig.json --noEmit`）。
- [ ] ブラウザ（実行環境）でコンポーネントを操作した際にコンソールに警告・エラーが出ないこと（DevTools で確認）。
- [ ] 実装によって追加のランタイムワーニングやアクセシビリティ問題が発生していないこと（必要に応じてユニット/統合テストや手動検証を実施）。

(参考: 実装方針や API の詳細は公式ドキュメントで裏取りしてください。外部参照で根拠を残すと、後続レビューがしやすくなります。）